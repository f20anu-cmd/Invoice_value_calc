<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Invoice Value Calculator</title>
  <meta name="theme-color" content="#1976d2"/>

  <!-- XLSX Reader -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <link rel="manifest" href="manifest.json"/>

  <style>
    body{
      font-family:-apple-system, BlinkMacSystemFont,"Segoe UI",Roboto;
      margin:0; background:#f5f6f8; padding-bottom:120px;
    }
    .header{
      background:#1976d2; color:white; padding:15px;
      font-size:18px; font-weight:900; position:sticky; top:0;
    }
    .card{
      background:white; margin:12px; padding:14px;
      border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    .row{ display:flex; gap:12px; }
    .row>div{ flex:1; }
    label{ font-size:12px; font-weight:900; color:#444; }
    input, select{
      width:100%; padding:10px; border-radius:10px; border:1px solid #ccc;
      margin-top:5px; font-size:15px;
    }
    button{
      width:100%; padding:12px; border:none; cursor:pointer;
      border-radius:12px; font-weight:900;
    }
    .primary{ background:#1976d2; color:white; }
    .ghost{ background:#e8e8e8; }

    table{
      width:100%; border-collapse:separate; border-spacing:0;
      min-width:850px;
    }
    th{
      background:#f3f5f8; padding:10px; font-size:12px;
      position:sticky; top:0; border-bottom:1px solid #ddd;
    }
    td{ padding:10px; border-bottom:1px solid #eee; }
    .num{ text-align:right; }

    .stickyBar{
      position:fixed; bottom:0; left:0; right:0; background:white;
      padding:12px; box-shadow:0 -4px 10px rgba(0,0,0,0.2);
    }
    #totalsCard div { font-size:16px; }
  </style>
</head>
<body>

<div class="header">Invoice Value Calculator</div>

<div class="card">
  <div class="row">
    <div>
      <label>Distributor</label>
      <select id="distributor" onchange="changeDistributor(this.value)"></select>
    </div>
    <div>
      <label>Salesman Name</label>
      <input id="salesman"/>
    </div>
  </div>
</div>

<div class="card">
  <button class="primary" onclick="addRow()">+ Add Row</button>
  <button class="ghost" onclick="clearAll()">Clear</button>
</div>

<div class="card">
  <div style="overflow:auto;">
    <table>
      <thead>
        <tr>
          <th>Product</th>
          <th>SKU</th>
          <th class="num">Rate (₹)</th>
          <th class="num">Units</th>
          <th class="num">Final Qty (L/Kg)</th>
          <th class="num">Disc%</th>
          <th class="num">Pre-GST</th>
          <th class="num">GST</th>
          <th class="num">Post-GST</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- TOTALS CARD -->
<div class="card" id="totalsCard">
  <div><b>Totals</b></div>
  <div class="row" style="margin-top:8px;">
    <div><b>Total Pre-GST:</b> ₹ <span id="t_pre">0.00</span></div>
    <div><b>Total GST:</b> ₹ <span id="t_gst">0.00</span></div>
    <div><b>Total Amount:</b> ₹ <span id="t_post">0.00</span></div>
  </div>
</div>

<!-- Sticky Footer -->
<div class="stickyBar">
  <button class="primary" onclick="savePdf()">Generate PDF</button>
</div>

<script src="js/loadMaster.js"></script>

<script>
let ROWS = [];
const MAX_ROWS = 10;
const $ = id => document.getElementById(id);

function addRow(){
  if (ROWS.length >= MAX_ROWS) return alert("Max 10 rows allowed");
  ROWS.push({product:"", sku:"", units:"", disc:"0"});
  render();
}

function removeRow(i){
  ROWS.splice(i,1);
  render();
}

function clearAll(){
  ROWS = [];
  render();
}

function itemUnit(i){
  const r = ROWS[i];
  if (!r.product || !r.sku) return "";
  return MASTER[r.product][r.sku].unit;
}

function render(){
  const tbody = $("tbody");
  tbody.innerHTML = "";

  ROWS.forEach((r,i)=>{
    const tr = document.createElement("tr");

    const productOptions = Object.keys(MASTER)
      .map(p => `<option value="${p}" ${r.product===p?'selected':''}>${p}</option>`)
      .join("");

    let skuOptions = "<option value=''>Select</option>";
    let rate = 0, finalQty = "", units = r.units || 0;

    if (r.product) {
      Object.keys(MASTER[r.product]).forEach(s=>{
        skuOptions += `<option value="${s}" ${r.sku===s?'selected':''}>${s}</option>`;
      });
    }

    if (r.product && r.sku && units) {
      const item = MASTER[r.product][r.sku];
      finalQty = (item.packSize * Number(units)).toFixed(2) + " " + item.unit;
      rate = item.rate;
    }

    tr.innerHTML = `
      <td><select onchange="ROWS[${i}].product=this.value; ROWS[${i}].sku=''; render()">
            <option value="">Select</option>${productOptions}</select></td>

      <td><select onchange="ROWS[${i}].sku=this.value; render()">${skuOptions}</select></td>

      <td class="num">${rate ? rate.toFixed(2) : "-"}</td>

      <td class="num">
        <input type="number" min="1" step="1" value="${r.units}"
               oninput="ROWS[${i}].units=this.value; calcTotals()"/>
      </td>

      <td class="num">${finalQty || "-"}</td>

      <td class="num">
        <input type="number" min="0" max="100" value="${r.disc}"
               oninput="ROWS[${i}].disc=this.value; calcTotals()"/>
      </td>

      <td class="num" id="pre_${i}">0.00</td>
      <td class="num" id="gst_${i}">0.00</td>
      <td class="num" id="post_${i}">0.00</td>

      <td><button onclick="removeRow(${i})">x</button></td>
    `;

    tbody.appendChild(tr);
  });

  calcTotals();
}

function calcTotals(){
  let preT=0, gstT=0, postT=0;

  ROWS.forEach((r,i)=>{
    if (!r.product || !r.sku || !r.units) return;

    const item = MASTER[r.product][r.sku];
    const rate = item.rate;
    const gstPct = item.gst;
    const units = Number(r.units);
    const discPct = Number(r.disc);

    const gross = rate * units;
    const discAmt = gross * (discPct/100);
    const pre = gross - discAmt;
    const gst = pre * (gstPct/100);
    const post = pre + gst;

    $("pre_"+i).textContent = pre.toFixed(2);
    $("gst_"+i).textContent = gst.toFixed(2);
    $("post_"+i).textContent = post.toFixed(2);

    preT += pre; gstT += gst; postT += post;
  });

  $("t_pre").textContent = preT.toFixed(2);
  $("t_gst").textContent = gstT.toFixed(2);
  $("t_post").textContent = postT.toFixed(2);
}

function savePdf(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const now = new Date();
  const timestamp = now.toLocaleDateString() + " " + now.toLocaleTimeString();

  doc.setFontSize(14);
  doc.text("Invoice Value Calculator", 14, 12);
  doc.setFontSize(11);
  doc.text(`Distributor: ${$("distributor").value}`, 14, 20);
  doc.text(`Salesman: ${$("salesman").value}`, 14, 26);
  doc.text(`Date & Time: ${timestamp}`, 14, 32);

  let rows = [];
  let preT=0, gstT=0, postT=0;

  ROWS.forEach(r=>{
    if (!r.product || !r.sku || !r.units) return;

    const item = MASTER[r.product][r.sku];
    const units = Number(r.units);
    const disc = Number(r.disc);

    const finalQty = (item.packSize * units).toFixed(2) + " " + item.unit;

    const gross = item.rate * units;
    const discAmt = gross * (disc/100);
    const pre = gross - discAmt;
    const gst = pre * (item.gst/100);
    const post = pre + gst;

    preT += pre; gstT += gst; postT += post;

    rows.push([
      r.sku,
      item.rate.toFixed(2),
      units,
      finalQty,
      disc,
      pre.toFixed(2),
      gst.toFixed(2),
      post.toFixed(2)
    ]);
  });

  doc.autoTable({
    startY: 40,
    head: [["SKU","Rate","Units","Final Qty (L/Kg)","Disc%","Pre-GST","GST","Post-GST"]],
    body: rows
  });

  let finalY = doc.lastAutoTable.finalY + 12;

  doc.text(`Total Pre-GST: ₹ ${preT.toFixed(2)}`, 14, finalY);
  doc.text(`Total GST: ₹ ${gstT.toFixed(2)}`, 14, finalY+6);
  doc.text(`Grand Total: ₹ ${postT.toFixed(2)}`, 14, finalY+12);

  doc.save("invoice.pdf");
}
</script>

</body>
</html>
