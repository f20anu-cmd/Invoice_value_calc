<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Invoice Value Calculator</title>

  <!-- XLSX for Excel parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --brand:#0a74d1;
      --brand2:#4f7fb8;
      --bg:#eef1f6;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;
    }

    * { box-sizing:border-box; }

    body {
      margin:0;
      background:var(--bg);
      font-family:system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color:var(--text);
      padding-bottom:130px; /* totals not hidden behind sticky PDF bar */
    }

    .header {
      background:var(--brand);
      color:#fff;
      padding:15px 16px;
      font-size:20px;
      font-weight:800;
      letter-spacing:0.2px;
    }

    .card {
      background:var(--card);
      padding:15px;
      margin:12px;
      border-radius:12px;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);
    }

    label {
      font-size:13px;
      font-weight:700;
      margin-bottom:6px;
      display:block;
      color:#0b2341;
    }

    input, select {
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid #cbd5e1;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    input:focus, select:focus{
      border-color: rgba(10,116,209,0.7);
      box-shadow: 0 0 0 3px rgba(10,116,209,0.12);
    }

    .btn-add {
      width:100%;
      padding:14px;
      margin-bottom:10px;
      background:var(--brand);
      color:white;
      font-size:16px;
      font-weight:800;
      border:none;
      border-radius:10px;
      cursor:pointer;
    }
    .btn-add:active { transform: translateY(1px); }

    .btn-clear {
      width:100%;
      padding:14px;
      background:var(--brand2);
      color:white;
      font-size:16px;
      font-weight:800;
      border:none;
      border-radius:10px;
      cursor:pointer;
    }
    .btn-clear:active { transform: translateY(1px); }

    /* TABLE */
    .tableWrap{
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      border-radius:12px;
    }

    table {
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width:860px;              /* reduced from 950 */
      table-layout: fixed;          /* controls width better */
    }

    thead th {
      background:var(--brand);
      color:white;
      padding:10px 8px;
      font-size:12px;
      border-bottom:1px solid rgba(255,255,255,0.15);
      text-align:left;
      vertical-align:bottom;
      white-space:normal;           /* allow 2-line headers */
      line-height:1.05;
    }

    tbody td {
      padding:10px 8px;
      border-bottom:1px solid var(--border);
      vertical-align:middle;
      white-space:nowrap;
      font-size:13px;
      background:#fff;
    }

    .num { text-align:right; }

    /* Column widths (helps reduce scroll) */
    col.col-product { width: 160px; }
    col.col-sku     { width: 140px; }
    col.col-rate    { width: 85px; }
    col.col-cases   { width: 70px; }
    col.col-final   { width: 120px; }
    col.col-units   { width: 80px; }
    col.col-disc    { width: 70px; }
    col.col-pre     { width: 90px; }
    col.col-gst     { width: 85px; }
    col.col-post    { width: 90px; }
    col.col-act     { width: 70px; }

    /* Compact numeric inputs */
    td input[type="number"]{
      width: 64px;
      max-width: 64px;
      padding:8px 8px;
      text-align:right;
      font-size:13px;
      border-radius:10px;
    }

    .btn-x{
      padding:6px 10px;
      border-radius:10px;
      border:1px solid #cbd5e1;
      background:#fff;
      cursor:pointer;
      font-weight:800;
      color:#0b2341;
    }
    .btn-x:active { transform: translateY(1px); }

    .stickyBar {
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      background:var(--brand);
      padding:10px;
      box-shadow:0 -2px 8px rgba(0,0,0,0.25);
      z-index:1000;
    }

    .stickyBar button {
      width:100%;
      padding:14px;
      background:white;
      color:var(--brand);
      font-size:16px;
      font-weight:900;
      border:none;
      border-radius:12px;
      cursor:pointer;
    }

    /* MOBILE */
    @media (max-width:600px) {
      .card { margin:8px; padding:12px; }
      .header { font-size:16px; padding:12px 14px; }

      label { font-size:12px; }
      input, select { padding:8px; font-size:12px; border-radius:10px; }

      .btn-add, .btn-clear, .stickyBar button { font-size:14px; padding:12px; }

      table { min-width:740px; } /* shorter scroll on mobile */

      thead th {
        font-size:11px;
        padding:8px 6px;
      }
      tbody td {
        font-size:12px;
        padding:8px 6px;
      }
      td input[type="number"]{
        width:56px;
        max-width:56px;
        padding:6px 6px;
        font-size:12px;
      }
      .btn-x{ padding:5px 8px; font-size:12px; }
    }
  </style>

</head>
<body>

<div class="header">Invoice Value Calculator</div>

<!-- Distributor + Retailer -->
<div class="card">
  <div style="margin-bottom:12px;">
    <label>Distributor</label>
    <select id="distributor" onchange="changeDistributor(this.value)"></select>
  </div>

  <div>
    <label>Retailer Name</label>
    <input id="retailer" placeholder="Enter retailer name"/>
  </div>
</div>

<!-- Add Row + Clear -->
<div class="card">
  <button class="btn-add" onclick="addRow()">+ Add Row</button>
  <button class="btn-clear" onclick="clearAll()">Clear</button>
</div>

<!-- Table -->
<div class="card">
  <div class="tableWrap">
    <table>
      <colgroup>
        <col class="col-product">
        <col class="col-sku">
        <col class="col-rate">
        <col class="col-cases">
        <col class="col-final">
        <col class="col-units">
        <col class="col-disc">
        <col class="col-pre">
        <col class="col-gst">
        <col class="col-post">
        <col class="col-act">
      </colgroup>

      <thead>
        <tr>
          <th>Product</th>
          <th>SKU</th>
          <th class="num">Rate<br>(Rs)</th>
          <th class="num">Cases</th>
          <th class="num">Final Qty<br>(L/Kg)</th>
          <th class="num">Units</th>
          <th class="num">Disc<br>(%)</th>
          <th class="num">Pre<br>(Rs)</th>
          <th class="num">GST<br>(Rs)</th>
          <th class="num">Post<br>(Rs)</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- Totals -->
<div class="card">
  <h3 style="margin-top:0;">Totals</h3>
  <div><b>Total Pre-GST:</b> <span id="t_pre">Rs. 0.00</span></div>
  <div><b>Total GST:</b> <span id="t_gst">Rs. 0.00</span></div>
  <div><b>Total Amount:</b> <span id="t_post">Rs. 0.00</span></div>
</div>

<!-- Sticky PDF Button -->
<div class="stickyBar">
  <button onclick="savePdf()">Generate PDF</button>
</div>

<script src="js/loadMaster.js"></script>

<script>
let ROWS = [];
const $ = id => document.getElementById(id);

function addRow() {
  ROWS.push({ product:"", sku:"", cases:"", disc:"0" });
  render();
}

function removeRow(i){
  ROWS.splice(i,1);
  render();
}

function clearAll(){
  ROWS = [];
  render();
}

function render(){
  const tbody = $("tbody");
  tbody.innerHTML = "";

  ROWS.forEach((r,i)=>{
    const tr = document.createElement("tr");

    const productOpts = Object.keys(MASTER)
      .sort()
      .map(p => `<option value="${p}" ${p===r.product?"selected":""}>${p}</option>`)
      .join("");

    let skuOpts = `<option value=''>Select</option>`;
    if (r.product) {
      Object.keys(MASTER[r.product]).forEach(sku=>{
        skuOpts += `<option value="${sku}" ${sku===r.sku?"selected":""}>${sku}</option>`;
      });
    }

    let rateTxt  = "-";
    let finalQty = "-";
    let unitsTxt = "-";

    if (r.product && r.sku) {
      const item = MASTER[r.product][r.sku];
      rateTxt = item.rate.toFixed(2);

      if (r.cases) {
        const cases = Number(r.cases);
        const totalQtyInLKg = (item.qtyPerCase * cases).toFixed(2);
        const numUnits = (Number(totalQtyInLKg) / item.packSize);
        finalQty = `${totalQtyInLKg} ${item.unit}`;
        unitsTxt = numUnits.toFixed(2);
      }
    }

    tr.innerHTML = `
      <td>
        <select onchange="ROWS[${i}].product=this.value; ROWS[${i}].sku=''; render()">
          <option value="">Select</option>${productOpts}
        </select>
      </td>

      <td>
        <select onchange="ROWS[${i}].sku=this.value; render()">${skuOpts}</select>
      </td>

      <td class="num">${rateTxt}</td>

      <td class="num">
        <input type="number" min="1" step="1" value="${r.cases}"
               oninput="ROWS[${i}].cases=this.value; render()"/>
      </td>

      <td class="num">${finalQty}</td>

      <td class="num">${unitsTxt}</td>

      <td class="num">
        <input type="number" min="0" max="100" value="${r.disc}"
               oninput="ROWS[${i}].disc=this.value; calcTotals()"/>
      </td>

      <td class="num" id="pre_${i}">0.00</td>
      <td class="num" id="gst_${i}">0.00</td>
      <td class="num" id="post_${i}">0.00</td>

      <td><button class="btn-x" onclick="removeRow(${i})">x</button></td>
    `;

    tbody.appendChild(tr);
  });

  calcTotals();
}

function calcTotals(){
  let preT=0, gstT=0, postT=0;

  ROWS.forEach((r,i)=>{
    if (!r.product || !r.sku || !r.cases) return;

    const item = MASTER[r.product][r.sku];
    const cases = Number(r.cases);
    const disc  = Number(r.disc) || 0;

    const totalQtyInLKg = item.qtyPerCase * cases;
    const numUnits = totalQtyInLKg / item.packSize;

    const gross   = item.rate * numUnits;
    const discAmt = gross * disc/100;
    const pre  = gross - discAmt;
    const gst  = pre * item.gst/100;
    const post = pre + gst;

    $("pre_"+i).textContent  = pre.toFixed(2);
    $("gst_"+i).textContent  = gst.toFixed(2);
    $("post_"+i).textContent = post.toFixed(2);

    preT+=pre; gstT+=gst; postT+=post;
  });

  $("t_pre").textContent  = "Rs. " + preT.toFixed(2);
  $("t_gst").textContent  = "Rs. " + gstT.toFixed(2);
  $("t_post").textContent = "Rs. " + postT.toFixed(2);
}

function savePdf(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const ts = new Date().toLocaleString();

  doc.setFontSize(14);
  doc.text("Invoice Value Calculator", 14, 14);

  doc.setFontSize(11);
  doc.text("Distributor: " + $("distributor").value, 14, 22);
  doc.text("Retailer: " + $("retailer").value, 14, 28);
  doc.text("Date & Time: " + ts, 14, 34);

  let rows = [];
  let preT=0, gstT=0, postT=0;

  ROWS.forEach(r=>{
    if (!r.product || !r.sku || !r.cases) return;

    const item = MASTER[r.product][r.sku];
    const cases = Number(r.cases);
    const disc  = Number(r.disc) || 0;

    const totalQtyInLKg = (item.qtyPerCase * cases);
    const numUnits = (totalQtyInLKg / item.packSize);
    const finalQty = totalQtyInLKg.toFixed(2) + " " + item.unit;

    const gross   = item.rate * numUnits;
    const discAmt = gross * disc/100;
    const pre  = gross - discAmt;
    const gst  = pre * item.gst/100;
    const post = pre + gst;

    preT+=pre; gstT+=gst; postT+=post;

    rows.push([
      r.product,
      r.sku,
      item.rate.toFixed(2),
      cases,
      finalQty,
      numUnits.toFixed(2),
      disc,
      pre.toFixed(2),
      gst.toFixed(2),
      post.toFixed(2)
    ]);
  });

  doc.autoTable({
    startY: 40,
    head: [["Product","SKU","Rate (Rs)","Cases","Final Qty (L/Kg)","Units","Disc%","Pre (Rs)","GST (Rs)","Post (Rs)"]],
    body: rows
  });

  let y = doc.lastAutoTable.finalY + 12;
  doc.text(`Total Pre-GST: Rs. ${preT.toFixed(2)}`, 14, y);
  doc.text(`Total GST: Rs. ${gstT.toFixed(2)}`, 14, y+6);
  doc.text(`Grand Total: Rs. ${postT.toFixed(2)}`, 14, y+12);

  doc.save("invoice.pdf");
}

render();
</script>

</body>
</html>
